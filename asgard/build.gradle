import nebula.core.tasks.Download
task download(type: Download) {
    downloadBase = 'https://github.com/Netflix/asgard/releases/download/asgard-1.5'
    downloadFileName = 'asgard.war'
}

// TODO tomcat_extra_opts: "-Darchaius.deployment.applicationId=asgard -Dnetflix.datacenter=cloud"
import org.apache.tools.ant.filters.*
ospackage {
    from(download) {
        into('/var/lib/tomcat7/webapps/')
        rename(/.*/, 'ROOT.war')
    }
    from(file('root')) {
        into('/')
        user = 'tomcat7'
        permissionGroup = 'tomcat7'

        def accountNumber = System.getenv('EC2_OWNER_ID')

        filter ReplaceTokens, tokens: [
                "ASGARD_PASSWORD": project.property("asgard.password"),
                "ACCOUNT_NUMBER": accountNumber
        ]
    }
    postInstall('mv /etc/tomcat7/tomcat-users.xml.asgard /etc/tomcat7/tomcat-users.xml')
}